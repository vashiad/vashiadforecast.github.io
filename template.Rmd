---
output: html_document
params:
  state: "OH"
  name: "Ohio"
title: "`r params$name`"
---
<style type="text/css">

body{ /* Normal  */
      font-size: 12px;
  }
td {  /* Table  */
  font-size: 14px;
  font-family: "Futura"
}
h1.title {
  font-size: 37px;
  font-family: "Futura";
}
h1 { /* Header 1 */
  font-size: 20px;
  font-weight: bold;
  font-family: "Futura";
}
h2 { /* Header 2 */
    font-size: 22px;
}
h3 { /* Header 3 */
  font-size: 18px;
  font-family: "Futura";
}
code.r{ /* Code block */
    font-size: 12px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 14px;
}


</style>

<style>
  .col2 {
    columns: 2 200px;         /* number of columns and width in pixels*/
    -webkit-columns: 2 200px; /* chrome, safari */
    -moz-columns: 2 200px;    /* firefox */
  }
  .col3 {
    columns: 3 100px;
    -webkit-columns: 3 100px;
    -moz-columns: 3 100px;
  }
</style>


```{r include = FALSE}
knitr::opts_chunk$set(echo=FALSE,message=FALSE,warning=FALSE)

```


```{r }
library(knitr)
library(scales)
library(dplyr)
library(usmap)
library(formattable)
library(kableExtra)
library(egg)


statesdata <- read.csv("~/Desktop/2020 Forecast Data/statescsv.csv")
statesdata <- statesdata %>%
  mutate("Date" = lubridate::as_datetime(statesdata$Date))

bidenstateresults <- read.csv("~/Desktop/2020 Forecast Data/bidenstateresults.csv")
trumpstateresults <- read.csv("~/Desktop/2020 Forecast Data/trumpstateresults.csv")
otherstateresults <- read.csv("~/Desktop/2020 Forecast Data/otherstateresults.csv")

stateresults <- function(state){
  datawrangle <- statesdata %>%
    filter(Abb.==state) %>%
    arrange(desc(Date))
  latestresults <- slice_max(datawrangle,order_by=Date,n=1)
  header <- htmltools::HTML(
      sprintf(
        '<div style="font-family:futura; font-size: 21px; width: 800px; float: left;">
<img src="BidenHead.png" alt="A picture of Joe Biden" style="width:75px;height:92px;float: left;"/>
<img src="TrumpHead.png" alt="A picture of Donald Trump" style="width:70px;height:92px;float: right;"/>
<strong>Biden</strong></span> <span style="float: right;"><strong>Trump</strong></span> <br /> 
<span style="font-size: 32px; color: #698dc5; float: left;"><strong>%s%%</strong></span> 
<span style="color: #f07763; font-size: 32px; float: right;"><strong>%s%%</strong></span><br clear="all" /> 
<span style="background: #698DC5; width: %s%%; float: left;">&nbsp;</span> 
<span style="background: #F07763; width: %s%%; float: right;">&nbsp;</span></div>',round(latestresults$BidenStateWinProb, 1),
round(latestresults$TrumpStateWinProb, 1),
latestresults$BidenStateWinProb,
latestresults$TrumpStateWinProb
      )
    )
  return(header)
}

maptile <- function(state){
  datawrangle <- statesdata %>%
    filter(Abb.==state) %>%
    arrange(desc(Date))
  latestresults <- slice_max(datawrangle,order_by=Date,n=1)
  statefig <- plot_usmap(include=state, color = "#000000",size=1.15,
                         fill=ifelse(latestresults$MarginAverage<0,"#698DC5","#F07763"))
  return(statefig)
}

electoralvotes <- function(state){
  datawrangle <- statesdata %>%
    filter(Abb.==state) %>%
    arrange(desc(Date))
  latestresults <- slice_max(datawrangle,order_by=Date,n=1)
  result <- htmltools::HTML(
      sprintf(
        '<div style="font-family:futura; font-size: 23px; width: 150px; text-align: center;"><span style="font-size:95px;font-weight:bold;text-align: center;">%s</span><br/> Electoral Votes</div>',latestresults$EV.s
      )
    )
  return(result)
}

table <- function(state){
  datawrangle <- statesdata %>%
  filter(Abb.==state) %>%
  arrange(desc(Date))
  latestresults <- slice_max(datawrangle,order_by=Date,n=1)
  df <- data.frame(" " <- c("◾","◾","◾"), "Candidate" <- c("Joe Biden","Donald Trump","Others"),
           "Projected voteshare"<-c(round(latestresults$BidenAverage,2),round(latestresults$TrumpAverage,2),round(latestresults$OtherAverage,2)))
  colnames(df) <- c(" ","Candidate","Projected voteshare")
  
  df %>%
      mutate(" " = cell_spec(" ", "html", background = ifelse(Candidate=="Joe Biden", "#698DC5", ifelse(Candidate=="Donald Trump","#F07763","#cf9800"))),
             `Projected voteshare`= ifelse(Candidate=="Joe Biden",color_bar("#cdcefa")(`Projected voteshare`),
                                         ifelse(Candidate=="Donald Trump",color_bar("#fcc7c0")(`Projected voteshare`),color_bar("#f7e3ab")(`Projected voteshare`)))) %>%
    kable("html",escape = F,align="r",position="left") %>%
    kable_styling("hover", full_width = F, font_size = 15) %>%
    row_spec(1, bold = T, color = NULL, background = "white", align="r") %>%
    row_spec(2, bold = T, color = NULL, background = "white", align="r") %>%
    row_spec(3, bold = T, color = NULL, background = "white", align="r") %>%
    column_spec(2, width = "2.5cm", bold=T)
}

# #c(round(mean(bidenstateresults[,c(state)]),2)/100,
#                                 round(mean(trumpstateresults[,c(state)]),2)/100,
#                                 round(mean(otherstateresults[,c(state)]),2)/100))


#State Chances Graph

statechances <- function(state){
  statechances <- statesdata %>%
    filter(Abb.==state)
  plot <- plot_ly(statechances,x=statechances$Date) %>%
  config(displayModeBar = FALSE) %>%
  add_trace(y=~BidenStateWinProb,name='Biden',mode='lines',line=list(color='rgb(105,141,197)',width=2.84)) %>%
  add_trace(y=~TrumpStateWinProb,name='Trump',mode='lines',line=list(color='rgb(240,119,99)',width=2.84)) %>%
  add_trace(y=~OtherStateWinProb,name='Others',mode='lines',line=list(color='rgb(207,152,0)',width=2.84)) %>%
  layout(margin = list(t=40),title = paste('Chances of winning',state,'over time'),
         font=list(family='Futura', size=12.8),
         xaxis = list(fixedrange=TRUE,title = 'Date',
                      zeroline = TRUE,spikecolor="black",
                      spikethickness=2,
                      range = (c(as.character(min(statesdata$Date)),"2020-08-04 00:38:14"))),
         yaxis = list(fixedrange=TRUE,title = 'Probability'),
         hovermode = "x unified",
         hoverlabel = list(font = list(family="Futura",
                                       size = 13.5 ),bgcolor='white'))
  return(plot)
}

#State Vote share Graph
statevoteshare <- function(state){
  statevoteshare <- statesdata %>%
    filter(Abb.==state)
  plot <- plot_ly(statevoteshare,x=statevoteshare$Date) %>%
  config(displayModeBar = FALSE) %>%
  add_trace(y=~BidenAverage,name='Biden',mode='lines',line=list(color='rgb(105,141,197)',width=2.84),hoverinfo="y") %>%
  add_trace(y=~TrumpAverage,name='Trump',mode='lines',line=list(color='rgb(240,119,99)',width=2.84),hoverinfo="y") %>%
  add_trace(y=~OtherAverage,name='Others',mode='lines',line=list(color='rgb(207,152,0)',width=2.84),hoverinfo="y") %>%
  add_trace(y=~BidenHigh,name='Biden High',type = 'scatter',mode='lines',line = list(color = 'transparent'),showlegend = FALSE,hoverinfo='none') %>%
  add_trace(y=~BidenLow,name='Biden Low',type = 'scatter',mode='lines',
    fill = 'tonexty',fillcolor='rgba(105,141,197,0.3)',
    line = list(color = 'transparent'),showlegend = FALSE,hoverinfo='none') %>%
  add_trace(y=~TrumpHigh,name='Trump High',type = 'scatter',mode='lines',line = list(color = 'transparent'),showlegend = FALSE,hoverinfo='none') %>%
  add_trace(y=~TrumpLow,name='Trump Low',type = 'scatter',mode='lines',
    fill = 'tonexty',fillcolor='rgba(240,119,99,0.3)',
    line = list(color = 'transparent'),showlegend = FALSE,hoverinfo='none') %>%
  layout(margin = list(t=40),title = paste(state,'Projected voteshare over time'),
         font=list(family='Futura', size=12.8),
         xaxis = list(fixedrange=TRUE,title = 'Date',
                      zeroline = TRUE,spikecolor="black",
                      spikethickness=2,
                      range = (c(as.character(min(statesdata$Date)),"2020-08-04 00:38:14"))),
         yaxis = list(hoverformat=".2f",fixedrange=TRUE,title = 'Probability'),
         hovermode = "x unified",
         hoverlabel = list(font = list(family="Futura",
                                       size = 13.5 ),bgcolor='white'))
  return(plot)
}



densityplot <- function(state){
  finalplot <- ggplot() + geom_density(data=bidenstateresults, aes_string(x=state),color="darkblue", fill="#698DC5",alpha=0.5) + 
    geom_density(data=trumpstateresults, aes_string(x=state),color="darkred", fill="#F07763",alpha=0.5) + xlab("Percent % voteshare") + ylab("Density") +
  scale_y_continuous(labels = percent_format()) + scale_x_continuous() + ggtitle(paste("The Possible Results in",state)) #geom_density(data=otherstateresults, aes(x=otherstateresults[,c(state)]),color="#cf9800", fill="#f7e3ab")
  #finalplot <- ggarrange(bidendensity,trumpdensity,otherdensity,ncol=1)
  finalplot <- ggplotly(finalplot) %>%
  config(displayModeBar = FALSE) %>%
  layout(margin = list(t=47),
         xaxis=list(hoverformat=".2f",fixedrange=TRUE,size=14),
         font = list(family='Futura', size=14),
         yaxis = list(hoverformat=".2f",fixedrange=TRUE,tickfont = list(size = 14)),
         showlegend=FALSE,
         hoverlabel = list(font = list(family="Futura",
                                       size = 13.5 ),bgcolor='white'))
  return(finalplot)
}


```

---

```{r,fig.align = "center",out.width="100%"}
stateresults(params$state)
```

<div class = "row">
<div class = "col-sm-4">

```{r,fig.align="left", fig.width=6, fig.height=2.7,out.width="100%"}
table(params$state)
```

</div>

<div class = "col-sm-4">
```{r,fig.align="center", fig.width=1.3, fig.height=1.3,out.width="70%"}
maptile(params$state)
```

</div>

<div class = "col-sm-4">
```{r,fig.align="left", out.width="100%"}
electoralvotes(params$state)
```

</div>

</div>

---

```{r,fig.align="center", fig.width=2, fig.height=1.95,out.width="75%"}
densityplot(params$state)
```

---

# How has the race changed over time?

##  {.tabset .tabset-fade .tabset-pills}

### Chance of winning

```{r,fig.width = 10, fig.asp = 0.47, out.width="700px", out.height="345.2px", fig.align = "center"}
statechances(params$state)
```

### Projected voteshare

```{r,fig.width = 10, fig.asp = 0.47, out.width="700px", out.height="345.2px", fig.align = "center"}
statevoteshare(params$state)
```

##

---
title: "Who will be President?"
---
```{r include = FALSE}
knitr::opts_chunk$set(echo=FALSE,message=FALSE,warning=FALSE)
```


```{r}
setwd("~/Desktop")

library(ggplot2)
library(tidyverse)
library(dplyr)
library(usmap)
library(maptools)
library(ggrepel)
library(haven)
library(leaflet)
library(magrittr)
library(tilegramsR)
library(shiny)

data <- read.csv("2020forecast.csv")

#Sharing the leftover vote
data$Leftovers <- 100 - (data$Trump + data$Biden)
data$Other <- data$Leftovers * 0.40
data$Trump2 <- data$Trump + (data$Leftovers * 0.30)
data$Biden2 <- data$Biden + (data$Leftovers * 0.30)

#Forecasting the national popoular vote using states
TrumpNPV1 <- weighted.mean(data$Trump2,data$EV.s)
BidenNPV1 <- weighted.mean(data$Biden2,data$EV.s)
OtherNPV1 <- weighted.mean(data$Other,data$EV.s)

#Forecasting the national popular vote using GE polling data
BidenNPVPollAvg <- 51.1 #Input polling aggregate data here
TrumpNPVPollAvg <- 41.5 #Input polling aggregate data here
OtherNPVPollAvg <- 100 - (BidenNPVPollAvg + TrumpNPVPollAvg)
BidenNPVPollAvg <- BidenNPVPollAvg + (OtherNPVPollAvg * 0.35)
TrumpNPVPollAvg <- TrumpNPVPollAvg + (OtherNPVPollAvg * 0.35)
OtherNPVPollAvg <- OtherNPVPollAvg * 0.30

#Forecasting national popular voting using both methods
TrumpNPV2 <- (TrumpNPV1*0.80) + (TrumpNPVPollAvg*0.20)
BidenNPV2 <- (BidenNPV1*0.80) + (BidenNPVPollAvg*0.20)
OtherNPV2 <- (OtherNPV1*0.80) + (OtherNPVPollAvg*0.20)
NPV2Margin <- BidenNPV2 - TrumpNPV2

#Regressions Strategy 1
data$Strategy1 <- data$Partisan.Lean - NPV2Margin
#make sure the negative sign is in order to correctly account for the differences

TrumpStrategy1 <- lm(data$Trump2 ~ data$Strategy1)
BidenStrategy1 <- lm(data$Biden2 ~ data$Strategy1)
OtherStrategy1 <- lm(data$Other ~ data$Strategy1)

data$TrumpStrategy1.1 <- predict(TrumpStrategy1)
data$BidenStrategy1.1 <- predict(BidenStrategy1)
data$OtherStrategy1.1 <- predict(OtherStrategy1)
data$AdjustStrategy1.1 <- (100-(data$TrumpStrategy1.1+data$BidenStrategy1.1+data$OtherStrategy1.1))/3
data$TrumpStrategy1.2 <- data$TrumpStrategy1.1 + data$AdjustStrategy1.1
data$BidenStrategy1.2 <- data$BidenStrategy1.1 + data$AdjustStrategy1.1
data$OtherStrategy1.2 <- data$OtherStrategy1.1 + data$AdjustStrategy1.1


#Regressions Strategy 2
RegPart <- aggregate(data$Partisan.Lean,by=list(data$Region),FUN=median)
data <- dplyr::left_join(data,RegPart,by=c("Region" = "Group.1"))

results76to16 <- read.csv("potus_results_76_16.csv")
histother <- aggregate(results76to16$other*100,by=list(results76to16$state),FUN=mean,na.rm=TRUE)
data <- dplyr::left_join(data,histother,by=c("Abb." = "Group.1"))

#Filling in NAs
data$x.y[data$Abb.=="ME 1st"]=histother$x[histother$Group.1=="ME"]
data$x.y[data$Abb.=="ME 2nd"]=histother$x[histother$Group.1=="ME"]
data$x.y[data$Abb.=="NE 1st"]=histother$x[histother$Group.1=="NE"]
data$x.y[data$Abb.=="NE 2nd"]=histother$x[histother$Group.1=="NE"]
data$x.y[data$Abb.=="NE 3rd"]=histother$x[histother$Group.1=="NE"]


TrumpStrategy2 <- lm(Trump2 ~ Partisan.Lean + x.x,data=data)
BidenStrategy2 <- lm(Biden2 ~ Partisan.Lean + x.x,data=data)
OtherStrategy2 <- lm(Other ~ x.y,data=data, na.action=na.exclude)

data$TrumpStrategy2.1 <- predict(TrumpStrategy2)
data$BidenStrategy2.1 <- predict(BidenStrategy2)
data$OtherStrategy2.1 <- predict(OtherStrategy2)
data$AdjustStrategy2.1 <- (100-(data$TrumpStrategy2.1+data$BidenStrategy2.1+data$OtherStrategy2.1))/3
data$TrumpStrategy2.2 <- data$TrumpStrategy2.1 + data$AdjustStrategy2.1
data$BidenStrategy2.2 <- data$BidenStrategy2.1 + data$AdjustStrategy2.1
data$OtherStrategy2.2 <- data$OtherStrategy2.1 + data$AdjustStrategy2.1

#Regression Strategy 3
data2 <- read.csv("Demographics2.csv")

TrumpStrategy3 <- lm(data$Trump2 ~ data$Partisan.Lean + data2$Hipanic.Latino + data2$White + data2$Black + data2$Am..Indian + data2$Asian + data2$Hawaiian.PI + data2$Other + data2$Mixed)
BidenStrategy3 <- lm(data$Biden2 ~ data$Partisan.Lean + data2$Hipanic.Latino + data2$White + data2$Black + data2$Am..Indian + data2$Asian + data2$Hawaiian.PI + data2$Other + data2$Mixed)
OtherStrategy3 <- lm(data$Other ~ data$Partisan.Lean + data2$Hipanic.Latino + data2$White + data2$Black + data2$Am..Indian + data2$Asian + data2$Hawaiian.PI + data2$Other + data2$Mixed)

data$TrumpStrategy3.1 <- predict(TrumpStrategy3)
data$BidenStrategy3.1 <- predict(BidenStrategy3)
data$OtherStrategy3.1 <- predict(OtherStrategy3)
data$AdjustStrategy3.1 <- (100-(data$TrumpStrategy3.1+data$BidenStrategy3.1+data$OtherStrategy3.1))/3
data$TrumpStrategy3.2 <- data$TrumpStrategy3.1 + data$AdjustStrategy3.1
data$BidenStrategy3.2 <- data$BidenStrategy3.1 + data$AdjustStrategy3.1
data$OtherStrategy3.2 <- data$OtherStrategy3.1 + data$AdjustStrategy3.1

#Combining Regressions
data$TrumpFinalRegression <- (data$TrumpStrategy1.2*0.30)+(data$TrumpStrategy2.2*0.50)+(data$TrumpStrategy3.2*0.20)
data$BidenFinalRegression <- (data$BidenStrategy1.2*0.30)+(data$BidenStrategy2.2*0.50)+(data$BidenStrategy3.2*0.20)
data$OtherFinalRegression <- (data$OtherStrategy1.2*0.30)+(data$OtherStrategy2.2*0.50)+(data$OtherStrategy3.2*0.20)

#Combining the Regressions with Aggregate Polling
DaysTilElection <- as.numeric(abs((Sys.Date()- as.Date("110320", "%m%d%y"))))
pollsweight <- ((0.0011852*((DaysTilElection)^2))-(0.412609*(DaysTilElection))+95)/100
regweight <- 1-pollsweight

data$FinalPredictedTrump <- (data$Trump2*pollsweight)+(data$TrumpFinalRegression*regweight)
data$FinalPredictedBiden <- (data$Biden2*pollsweight)+(data$BidenFinalRegression*regweight)
data$FinalPredictedOther <- (data$Other*pollsweight)+(data$OtherFinalRegression*regweight)

#Correlation Matrix
cormatrix <- cor(t(data2[-1:-2]))
colnames(cormatrix) <- data2$State
rownames(cormatrix) <- data2$State
cormatrix <- data.frame(cormatrix)

#Simulating National Error

NatMarginOfError <- ((0.0000758945*(DaysTilElection)^2)+(0.00708671*(DaysTilElection))+(100-(mean(data$Trump)+mean(data$Biden)))/2)

MOE <- function(NatMarginOfError){
  x <- rt(1,10)
  x <- x/2 #95% chance
  x <- x * NatMarginOfError
  return(x)
} 

#Simulating Demographic Error

DemographicError <- function(){
  samplecolumn <- sample(cormatrix,1)
  samplerror <- rnorm(1,sd=3)
  samplecolumn <- data.frame(samplecolumn * samplerror * data$Elasticity)
  return(samplecolumn)
}

simulations <- data %>%
  select(Abb., EV.s, Name,Region,Elasticity,FinalPredictedTrump,FinalPredictedBiden,FinalPredictedOther) %>%
  mutate(TrumpWin=0) %>%
  mutate(BidenWin=0) %>%
  mutate(OtherWin=0)

nsims <- 1000

TrumpEVWinCount <- 0
BidenEVWinCount <- 0
OtherEVWinCount <- 0
TieEVCount <- 0

TrumpEVWinVector <- rep(NA, nsims)
BidenEVWinVector <- rep(NA, nsims)
OtherEVWinVector <- rep(NA, nsims)

bidenstateresults <- matrix(NA, nrow = nsims, ncol = length(data$Name))
colnames(bidenstateresults) <- data$Name
trumpstateresults <- matrix(NA, nrow = nsims, ncol = length(data$Name))
colnames(trumpstateresults) <- data$Name
otherstateresults <- matrix(NA, nrow = nsims, ncol = length(data$Name))
colnames(otherstateresults) <- data$Name


for (x in 1:nsims){
  TrumpVoteEV <- 0
  BidenVoteEV  <- 0
  OtherVoteEV <- 0
  #Simulating Regional Error
  RegError <- data.frame("Regions" <- RegPart$Group.1)
  RegionalErrorFixed <- (abs(rt(length(RegPart$Group.1),10)))
  RegError$Error <- ((rnorm(length(RegPart$Group.1),sd=3))*RegionalErrorFixed)
  names(RegError)[1] <- "Region"
  simulations <- dplyr::left_join(simulations,RegError,by=c("Region" = "Region"))
  #Simulating Demographic Error
  DemographicErrorStored <- DemographicError()
  for (i in 1:length(simulations$Name)){
    OneTrumpSim <- simulations$FinalPredictedTrump[i]
    OneBidenSim <- simulations$FinalPredictedBiden[i]
    OneOtherSim <- simulations$FinalPredictedOther[i]
    OneAdjustedVote <- MOE(NatMarginOfError)*simulations$Elasticity[i]
    TwoAdjustedVote <- simulations$Error[i]*simulations$Elasticity[i]
    ThreeAdjustedVote <- DemographicErrorStored[i,1]
    OneStateSimResult <- c(OneTrumpSim+OneAdjustedVote+TwoAdjustedVote+ThreeAdjustedVote,
                           OneBidenSim-OneAdjustedVote-TwoAdjustedVote-ThreeAdjustedVote,
                           OneOtherSim)
    trumpstateresults[x,i] <- OneStateSimResult[1]
    bidenstateresults[x,i] <- OneStateSimResult[2]
    otherstateresults[x,i] <- OneStateSimResult[3]
    ifelse(OneStateSimResult[1] > OneStateSimResult[2] & OneStateSimResult[3],
           simulations$TrumpWin[i] <- simulations$TrumpWin[i]+1,
           ifelse(OneStateSimResult[2] > OneStateSimResult[1] & OneStateSimResult[3],
                  simulations$BidenWin[i] <- simulations$BidenWin[i]+1,
                  simulations$OtherWin[i] <- simulations$OtherWin[i]+1))
    ifelse(OneStateSimResult[1] > OneStateSimResult[2] & OneStateSimResult[3],
           TrumpVoteEV <- TrumpVoteEV + simulations$EV.s[i],
           ifelse(OneStateSimResult[2] > OneStateSimResult[1] & OneStateSimResult[3],
                  BidenVoteEV <- BidenVoteEV + simulations$EV.s[i],
                  OtherVoteEV <- OtherVoteEV + simulations$EV.s[i]))
  }
  TrumpEVWinVector[x] <- TrumpVoteEV
  BidenEVWinVector[x] <- BidenVoteEV
  OtherEVWinVector[x] <- OtherVoteEV
  if (TrumpVoteEV>=270){
    TrumpEVWinCount = TrumpEVWinCount + 1
  } else {
    if (BidenVoteEV>=270){
      BidenEVWinCount = BidenEVWinCount + 1
    } else {
      if (OtherVoteEV>=270){
        OtherEVWinCount = OtherEVWinCount + 1
      } else {
        TieEVCount = TieEVCount + 1
      }
    }
  }
  simulations <- simulations[-c(12)]
}

TProbability <- (TrumpEVWinCount/nsims)*100
BProbability <- (BidenEVWinCount/nsims)*100
OProbability <- (OtherEVWinCount/nsims)*100
TieProbability <- (TieEVCount/nsims)*100

#paste("Trump wins the Elecoral College",TProbability,"% of times.")
#paste("Biden wins the Elecoral College",BProbability,"% of times.")
#paste("A Third Party Candidate wins the Elecoral College",OProbability,"% of times.")
#paste("No one wins the Elecoral College (Tie)",TieProbability,"% of times.")

simulations$TrumpStateWinProb <- (simulations$TrumpWin / (simulations$TrumpWin + simulations$BidenWin + simulations$OtherWin))*100
simulations$BidenStateWinProb <- (simulations$BidenWin / (simulations$TrumpWin + simulations$BidenWin + simulations$OtherWin))*100
simulations$OtherStateWinProb <- (simulations$OtherWin / (simulations$TrumpWin + simulations$BidenWin + simulations$OtherWin))*100

simulations <- cbind(fips = fips(simulations$Name), simulations)
simulations <- simulations %>% drop_na()


#Percentiles

percentiles <- function(candidate){
  dataframe <- data.frame()
  for (i in 1:ncol(candidate)){
    dataframe[i,1] <- colnames(candidate)[i]
    dataframe[i,2] <- quantile(candidate[,i],0.20)
    dataframe[i,3] <- mean(candidate[,i])
    dataframe[i,4] <- quantile(candidate[,i],0.80)
  }
  return(dataframe)
}
bidenpercentiles <- percentiles(bidenstateresults)
trumppercentiles <- percentiles(trumpstateresults)
otherpercentiles <- percentiles(otherstateresults)

#knitr::include_graphics(rep('/Users/aditya/Desktop/vashiadforecast.github.io/index_files/figure-html/BidenHead.png', 1))

htmltools::HTML(sprintf('<div style="font-family:futura; font-size: 22px; width: 750px; float: left;" id="Header">
<img src="BidenHead.png" alt="A picture of Joe Biden" style="width:110px;height:130px;float: left;"/>
<img src="TrumpHead.png" alt="A picture of Donald Trump" style="width:105px;height:130px;float: right;"/>
<strong>Biden</strong></span> <span style="float: right;"><strong>Trump</strong></span> <br /> <span style="font-size: 50px; color: #698dc5; float: left;"><strong>%s%%</strong></span> <span style="color: #f07763; font-size: 50px; float: right;"><strong>%s%%</strong></span><br clear="all" /> <span style="background: #698DC5; width: %s%%; float: left;">&nbsp;</span> <span style="background: #F07763; width: %s%%; float: right;">&nbsp;</span></div>',round(BProbability,1),round(TProbability,1),BProbability,TProbability))


#Chance Map
chancemap <- plot_usmap(data = simulations, values = "TrumpStateWinProb", color = "black",size=0.55) + 
  scale_fill_gradient2(
    low = "#698DC5", mid="white",high = "#F07763", name = "% Chance", midpoint=50,label = scales::comma
  ) + theme(legend.position = "right")

finalEV <- data.frame("BidenEV"=BidenEVWinVector,
                      "TrumpEV"=TrumpEVWinVector)


#Histogram
final_evs.gg <-  ggplot(data=finalEV,aes(x=BidenEV,
                                    fill=ifelse(BidenEV>=270,'Biden Wins','Trump Wins'))) +
  geom_vline(xintercept = 270) +
  geom_histogram(binwidth=1) +
  theme_minimal() +
  theme(legend.position = 'top',
        panel.grid.minor = element_blank()) +
  scale_fill_manual(name='Legend',values=c('Biden Wins'='#698DC5','Trump Wins'='#F07763'))+
  labs(x='Democratic electoral college votes',title='A Histogram of Electoral College Outcomes',
       subtitle=sprintf("After 20,000 simulations, Biden wins the electoral college %s percent of times. \nHere are the most likely outcomes.",round(mean(finalEV$BidenEV>=270)*100,3)))

#Margin Map
party_colors <- c("#698DC5","#F07763") 

p0 <- ggplot(data = simulations,
             mapping = aes(x = TrumpStateWinProb,
                           y = reorder(Name, TrumpStateWinProb),
                           color = TrumpStateWinProb>50))

p1 <- p0 + geom_vline(xintercept = 50, color = "gray30") +
  geom_point(size = 2)

p2 <- p1 + scale_color_manual(values = party_colors)

p3 <- p2 + scale_x_continuous(breaks = c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100),
                              labels = c("0\n (Biden)", "10", "20", "30", "40", "50", "60", "70", "80",
                                         "90", "100\n(Trump)"))

p4 <- p3 + labs(x = "Chance of Trump Win", y = "State") +
  theme(axis.text=element_text(size=8))

```

```{r}

##### INTERACTIVE MAP ######
#install.packages("remotes")
#library(remotes)
#remotes::install_github("hrbrmstr/albersusa")

#Interactive Leaflet Map
ensureCranPkg <- function(pkg) {
  if(!suppressWarnings(requireNamespace(pkg, quietly = TRUE))) {
    install.packages(pkg)
  }
}

ensureCranPkg('devtools')
ensureCranPkg('purrr')
ensureCranPkg('dplyr')
ensureCranPkg('htmlwidgets')
ensureCranPkg('stringr')
ensureCranPkg('rvest')
ensureCranPkg('xml2')
ensureCranPkg('htmltools')

if(!suppressWarnings(requireNamespace('leaflet',quietly = TRUE)) ||
   packageVersion('leaflet') < '1.0.2.9006') {
  devtools::install_github('rstudio/leaflet')
}

if(!suppressWarnings(requireNamespace('tilegramsR', quietly = TRUE))) {
  devtools::install_github('bhaskarvk/tilegramsR')
}

if(!suppressWarnings(requireNamespace('usgazetteer', quietly = TRUE))) {
  devtools::install_github('bhaskarvk/usgazetteer')
}

library(albersusa)
simulations$who=factor(ifelse(simulations$BidenStateWinProb>simulations$TrumpStateWinProb,'D','R'))
spatialdata2 <- rmapshaper::ms_simplify(albersusa::usa_composite())
#simulations <- simulations %<>% arrange(state)
colnames(simulations)[2] <- "iso_3166_2"
spatialdata2@data %<>% dplyr::left_join(simulations, by=c("iso_3166_2"="iso_3166_2"))


# This is our pretty hover content
spatialdata2@data$hoverText <- mapply(
  function(st, vts, dem, rep, w) {
    htmltools::HTML(
      sprintf("<div style='font-size:12px;width:200px;float:left'>
            <span style='font-size:18px;font-weight:bold'>%s</span><br/>
            Chances of Winning<br/>
            <div style='width:95%%'>
              <span style='float:left'>Biden</span>
              <span style='float:right'>Trump</span>
              <br/>
              <span style='color:#698DC5;float:left'>%s%%</span>
              <span style='color:#F07763;float:right'>%s%%</span><br clear='all'/>
              <span style='background:#698DC5;width:%s%%;float:left'>&nbsp;</span>
              <span style='background:#F07763;width:%s%%;float:right'>&nbsp;</span>
            </div>
            <br/><span style='font-size:10px'>%s Electoral Votes</span>
        </div>",usgazetteer::state.areas.2010$State[which(usgazetteer::state.areas.2010$USPS==st)],
              dem, rep,
              dem, rep,
              vts))
  },
  spatialdata2@data$iso_3166_2, spatialdata2@data$EV.s,
  spatialdata2@data$BidenStateWinProb, spatialdata2@data$TrumpStateWinProb,
  spatialdata2@data$who, SIMPLIFY = F) %>%
  set_names(spatialdata2@data$states)

#Coding the interactive leaflet map
# Dems are blue and Reps are red.
factpal <- colorFactor(c("#698DC5","#F07763"), spatialdata2@data$who)

crs.laea <- leafletCRS(
  crsClass="L.Proj.CRS", code='EPSG:2163',
  proj4def='+proj=laea +lat_0=45 +lon_0=-100 +x_0=0 +y_0=0 +a=6370997 +b=6370997 +units=m +no_defs',
  resolutions = c(65536, 32768, 16384, 8192, 4096, 2048,1024, 512, 256, 128))



leaflet(spatialdata2,options=leafletOptions(crs = crs.laea,
                                            minZoom = 3, maxZoom = 3,
                                            dragging = FALSE, zoomControl = FALSE,
                                            attributionControl = FALSE)) %>%
  addPolygons(data=spatialdata2, group = 'states',
              weight=1, color='#222',
              fillColor= ~factpal(who), fill = T, opacity = 1,
              fillOpacity = ~ifelse(spatialdata2@data$TrumpStateWinProb<=10,1,
                                    ifelse(spatialdata2@data$TrumpStateWinProb<=20,.80,
                                           ifelse(spatialdata2@data$TrumpStateWinProb<=30,.40,
                                                  ifelse(spatialdata2@data$TrumpStateWinProb<=40,.20,
                                                         ifelse(spatialdata2@data$TrumpStateWinProb<=50,.15,
                                                                ifelse(spatialdata2@data$TrumpStateWinProb<=60,.15,
                                                                       ifelse(spatialdata2@data$TrumpStateWinProb<=70,.20,
                                                                              ifelse(spatialdata2@data$TrumpStateWinProb<=80,.40,
                                                                                     ifelse(spatialdata2@data$TrumpStateWinProb<=90,.80,1))))))))),
              label=~hoverText,
              labelOptions = labelOptions(offset = c(-70,-30),
                                          #direction='bottom',
                                          textOnly = T,
                                          style=list(
                                            'background'='rgba(255,255,255,0.95)',
                                            'border-color' = 'rgba(0,0,0,1)',
                                            'border-radius' = '4px',
                                            'border-style' = 'solid',
                                            'border-width' = '4px')),
              highlightOptions = highlightOptions(weight = 3, bringToFront = TRUE)) %>%
  addLegend("bottomright", 
            colors =c("#698DC5", "#F07763"),
            labels= c("Biden", "Trump"),
            title= "Key",
            opacity = 1) %>%
  # addLabelOnlyMarkers(
  #   data=FiveThirtyEightElectoralCollege.centers,
  #   label = spatialdata2$EV.s,
  #   labelOptions = labelOptions(
  #     noHide = 'T', textOnly = T,
  #     offset=c(-2,0), textsize = '11px',
  #     style=list('color'='black')))  %>%
  htmlwidgets::onRender(
    "function(el, t) {
        var myMap = this;
        // get rid of the ugly grey background
        myMap._container.style['background'] = '#ffffff';
    }")
```

## Tile Map
This is an alternative method to look at the election map. Each state is visualized by the number of electoral votes it has. 

```{r}
#Interactive Leaflet Map
ensureCranPkg <- function(pkg) {
  if(!suppressWarnings(requireNamespace(pkg, quietly = TRUE))) {
    install.packages(pkg)
  }
}

ensureCranPkg('devtools')
ensureCranPkg('purrr')
ensureCranPkg('dplyr')
ensureCranPkg('htmlwidgets')
ensureCranPkg('stringr')
ensureCranPkg('rvest')
ensureCranPkg('xml2')
ensureCranPkg('htmltools')

if(!suppressWarnings(requireNamespace('leaflet',quietly = TRUE)) ||
   packageVersion('leaflet') < '1.0.2.9006') {
  devtools::install_github('rstudio/leaflet')
}

if(!suppressWarnings(requireNamespace('tilegramsR', quietly = TRUE))) {
  devtools::install_github('bhaskarvk/tilegramsR')
}

if(!suppressWarnings(requireNamespace('usgazetteer', quietly = TRUE))) {
  devtools::install_github('bhaskarvk/usgazetteer')
}

library(leaflet)
library(magrittr)
library(tilegramsR)

# Join with the spatial data from tilegramsR package
#spdf <- FiveThirtyEightElectoralCollege.states
#spdf@data %<>% dplyr::left_join(winprobs, by=c('state'='state'))

#Adding additional stuff
simulations$who=factor(ifelse(simulations$BidenStateWinProb>simulations$TrumpStateWinProb,'D','R'))
colnames(simulations)[2] <- "state"
spatialdata <- FiveThirtyEightElectoralCollege.states
spatialdata@data %<>% dplyr::left_join(simulations, by=c('state'='state'))

# This is our pretty hover content
spatialdata@data$hoverText <- mapply(
  function(st, vts, dem, rep, w) {
    htmltools::HTML(
      sprintf("<div style='font-size:12px;width:200px;float:left'>
            <span style='font-size:18px;font-weight:bold'>%s</span><br/>
            Chances of Winning<br/>
            <div style='width:95%%'>
              <span style='float:left'>Biden</span>
              <span style='float:right'>Trump</span>
              <br/>
              <span style='color:#698DC5;float:left'>%s%%</span>
              <span style='color:#F07763;float:right'>%s%%</span><br clear='all'/>
              <span style='background:#698DC5;width:%s%%;float:left'>&nbsp;</span>
              <span style='background:#F07763;width:%s%%;float:right'>&nbsp;</span>
            </div>
            <br/><span style='font-size:10px'>%s Electoral Votes</span>
        </div>",usgazetteer::state.areas.2010$State[which(usgazetteer::state.areas.2010$USPS==st)],
              dem, rep,
              dem, rep,
              vts))
  },
  spatialdata@data$state, spatialdata@data$EV.s,
  spatialdata@data$BidenStateWinProb, spatialdata@data$TrumpStateWinProb,
  spatialdata@data$who, SIMPLIFY = F) %>%
  set_names(spatialdata@data$states)

#Coding the interactive leaflet map
# Dems are blue and Reps are red.
factpal <- colorFactor(c("#698DC5","#F07763"), spatialdata@data$who)

leaflet(options=leafletOptions(crs = leafletCRS("L.CRS.Simple"),
                               minZoom = -2.35, maxZoom = -2.35,
                               dragging = FALSE, zoomControl = FALSE,
                               attributionControl = FALSE)) %>%
  addPolygons(data=FiveThirtyEightElectoralCollege, group = 'college',
              weight=1,color='#000', fill=F, opacity=0.3) %>%
  addPolygons(data=spatialdata, group = 'states',
              weight=1, color='#222',
              fillColor= ~factpal(who), fill = T, opacity = 1,
              fillOpacity = ~ifelse(who=='D',(BidenStateWinProb/100)-0.1,
                                    (TrumpStateWinProb/100)-0.1),
              label=~hoverText,
              labelOptions = labelOptions(offset = c(-60,-50),
                                          #direction='bottom',
                                          textOnly = T,
                                          style=list(
                                            'background'='rgba(255,255,255,0.95)',
                                            'border-color' = 'rgba(0,0,0,1)',
                                            'border-radius' = '4px',
                                            'border-style' = 'solid',
                                            'border-width' = '4px')),
              highlightOptions = highlightOptions(weight = 3, bringToFront = TRUE)) %>%
  # addLabelOnlyMarkers(
  #   data=FiveThirtyEightElectoralCollege.centers,
  #   label = spatialdata$state,
  #   labelOptions = labelOptions(
  #     noHide = 'T', textOnly = T,
  #     offset=c(-2,0), textsize = '11px',
  #     style=list('color'='black')))  %>%
  htmlwidgets::onRender(
    "function(el, t) {
        var myMap = this;
        // get rid of the ugly grey background
        myMap._container.style['background'] = '#ffffff';
    }")

```


## A Tale of 20,000 Individual Simulations
The model simulates the presidential 20,000 times. These are the most common electoral results.

```{r}
final_evs.gg
```


## State Outcomes
The highlighted bar represents an 80% chance that the margin of victory will lie inside the range.

```{r}

#Box plots
marginstateresults <- trumpstateresults-bidenstateresults
marginpercentiles <- percentiles(marginstateresults)
marginpercentiles <- arrange(marginpercentiles,V3)
marginpercentiles$ymin <- 1:56
marginpercentiles$ymin <- marginpercentiles$ymin - 0.40
marginpercentiles$ymax <- marginpercentiles$ymin + 0.80

party_colors <- c("#698DC5","#F07763") 

p0 <- ggplot(data = marginpercentiles,
             mapping = aes(x = V3,
                           y = reorder(V1,V3),
                           color = V3>0))

p1 <- p0 + geom_vline(xintercept = 0, color = "gray30") +
  geom_point(shape=16,size = 2) +
  geom_rect(data=marginpercentiles, mapping=aes(xmin=ifelse(V2<0,V2,0), 
                                                xmax=ifelse(V4<0,V4,0), 
                                                ymin=ymin,ymax=ymax,
                                                fill="red"),color="black",alpha=0.2) +
  geom_rect(data=marginpercentiles, mapping=aes(xmin=ifelse(V2>0,V2,0), 
                                                xmax=ifelse(V4>0,V4,0), 
                                                ymin=ymin,ymax=ymax,
                                                fill="blue"),color="black",alpha=0.2)

p2 <- p1 + scale_color_manual(values = party_colors)

p3 <- p2 + scale_x_continuous(breaks = c(-90, -75, -50, -25, 0, 25, 50),
                              labels = c("-90\n (Biden)", "-75", "-50","-25", "0", "25", "50\n(Trump)"))

p3 + labs(x = "Margin of Victory", y = "State") +
  theme(axis.text=element_text(size=8)) + theme_minimal()

#rmarkdown::render_site()
```

